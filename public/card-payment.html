<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pago con Tarjeta o PayPal - Impulso Digital</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://www.paypal.com/sdk/js?client-id=AcJZnqdJ2L7ZgHkxbqU5bLmbox6IzVlEBBDBlLRiLLkYNv5jdca-EZiAVJqRRxhjbQoZcEjCuzW8NG2u&currency=USD"></script></head>
<body>

    <header class="main-header">
        <div class="header-container">
            <h1 class="logo"><a href="index.html" style="text-decoration:none;color:#3498db;">Impulso Digital</a></h1>
        </div>
    </header>

    <main class="main-content">
        <div id="payment-form-container" class="payment-card">
            <h2>Resumen del producto</h2>
            <div id="product-summary" class="product-summary-card"></div>
            
            <div id="card-payment-form" class="payment-form">
                <div class="form-group">
                    <label for="full-name">Nombre completo</label>
                    <input type="text" id="full-name" name="full-name" placeholder="Tu nombre y apellido" required>
                </div>
                <div class="form-group">
                    <label for="email">Correo electrónico</label>
                    <input type="email" id="email" name="email" placeholder="tu-correo@ejemplo.com" required>
                </div>
                
                <p class="info-message">
                    Una vez realizado el pago, revisa tu correo (incluida la carpeta SPAM). Recibirás el producto automáticamente.
                </p>

                <div id="paypal-button-container"></div>
                
                <p class="small-text"><a href="javascript:history.back()">Volver a opciones de pago</a></p>
            </div>
        </div>
    </main>

    <footer>
        <p>Contacto: info@impulsodigital.com | &copy; 2024 Impulso Digital</p>
    </footer>

    <script>
        let selectedProduct = null;
        const urlParams = new URLSearchParams(window.location.search);
        const courseId = urlParams.get('id');
        
        function initPayPalButton() {
            if (!selectedProduct) {
                setTimeout(initPayPalButton, 100);
                return;
            }

            paypal.Buttons({
                createOrder: (data, actions) => {
                    return fetch("/api/orders", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ courseId: selectedProduct.id }),
                    })
                    .then(response => response.json())
                    .then(order => order.id);
                },

                onApprove: (data, actions) => {
                    const customerName = document.getElementById('full-name').value;
                    const customerEmail = document.getElementById('email').value;

                    if (!customerName || !customerEmail) {
                        alert('Por favor, completa tu nombre y correo electrónico para continuar.');
                        return actions.restart();
                    }

                    // --- CAMBIO AQUÍ ---
                    // Ahora también enviamos el 'courseId' al servidor
                    return fetch(`/api/orders/${data.orderID}/capture`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            customerName: customerName,
                            customerEmail: customerEmail,
                            courseId: courseId // Añadimos el ID del curso
                        })
                    })
                    .then(response => response.json())
                    .then(orderData => {
                        console.log('Capture result', orderData);
                        alert(`¡Pago completado con éxito! Recibirás tu producto en tu correo.`);
                    });
                },

                onError: (err) => {
                    console.error("Error en el proceso de pago de PayPal:", err);
                    alert("Ocurrió un error al procesar tu pago. Por favor, inténtalo de nuevo.");
                }
            }).render('#paypal-button-container');
        }

        async function loadProductSummary() {
            if (!courseId) {
                document.getElementById('product-summary').innerHTML = '<p>Error: No se ha especificado un producto.</p>';
                return;
            }
            try {
                const response = await fetch('data/courses.json');
                const courses = await response.json();
                selectedProduct = courses.find(c => c.id === courseId);
                if (selectedProduct) {
                    document.getElementById('product-summary').innerHTML = `<img src="images/${selectedProduct.id}.jpg" alt="${selectedProduct.title}" class="product-image"><div class="product-details"><h3>Producto: ${selectedProduct.title}</h3><p>Precio: <strong>$${selectedProduct.price}</strong></p></div>`;
                } else {
                     document.getElementById('product-summary').innerHTML = '<p>Error: Producto no encontrado.</p>';
                }
            } catch (error) {
                console.error('Error al cargar el resumen del producto:', error);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadProductSummary().then(initPayPalButton);
        });
    </script>

    <a href="https://wa.me/51964390939?text=Hola%2C%20tengo%20una%20pregunta%20sobre%20los%20cursos%20de%20Impulso%20Digital." class="whatsapp-fab" target="_blank" aria-label="Contactar por WhatsApp">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512">
        <path d="M380.9 97.1C339 55.1 283.2 32 223.9 32c-122.4 0-222 99.6-222 222 0 39.1 10.2 77.3 29.6 111L0 480l117.7-30.9c32.4 17.7 68.9 27 106.1 27h.1c122.3 0 224.1-99.6 224.1-222 0-59.3-25.2-115-67.1-157zm-157 341.6c-33.8 0-67.6-9.5-97.2-27.2l-6.7-4-71.6 18.7L50 312.5l-4.4-7c-18.5-29.4-28.2-63.3-28.2-98.2 0-101.7 82.8-184.5 184.6-184.5 49.3 0 95.6 19.2 130.4 54.1 34.8 34.9 56.2 81.2 56.1 130.5 0 101.8-84.9 184.6-186.6 184.6zm101.2-138.2c-5.5-2.8-32.8-16.2-37.9-18-5.1-1.9-8.8-2.8-12.5 2.8-3.7 5.6-14.3 18-17.6 21.8-3.2 3.7-6.5 4.2-12 1.4-32.8-16.2-54-29.1-75.5-66-5.7-9.8 5.7-9.1 16.3-30.3 1.8-3.7 .9-6.9-.5-9.7-1.4-2.8-12.5-30.1-17.1-41.2-4.5-10.8-9.1-9.3-12.5-9.5-3.2-.2-6.9-.2-10.6-.2-3.7 0-9.7 1.4-14.8 6.9-5.1 5.6-19.4 19-19.4 46.3 0 27.3 19.9 53.7 22.6 57.4 2.8 3.7 39.1 59.7 94.8 83.8 35.2 15.2 49 16.5 66.6 13.9 10.7-1.6 32.8-13.4 37.4-26.4 4.6-13 4.6-24.1 3.2-26.4-1.3-2.5-5-3.9-10.5-6.6z"/>
    </svg>
</a>
</body>
</html>